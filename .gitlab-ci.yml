# --------------------------------------------------------
# Base Windows Job Template
# Contains shared configuration for Windows-based jobs
# --------------------------------------------------------
.windows_job:
  tags:
    # Runner tags; uncomment and adjust as needed
    #- saas-windows-medium-amd64
    - win10-musterbau

  before_script:
    # Capture current time
    - Set-Variable -Name "time" -Value (date -Format "%H:%m")
    - echo ${time}

    # Print user who triggered the pipeline - just for testing and debugging
    - echo "started by ${GITLAB_USER_NAME} / @${GITLAB_USER_LOGIN}"
    - echo "started for project dir ${CI_PROJECT_DIR}"

    # Print the computer name of the runner - just for testing and debugging
    - 'Write-Output "Running on computer: $env:COMPUTERNAME"'


# --------------------------------------------------------
# Build Job
# --------------------------------------------------------
build:
  extends:
    - .windows_job   # Inherit configuration from base Windows job
  stage: build       # Pipeline stage
  rules:
    - if: $CI_COMMIT_TAG          # Run when a tag is created
    - if: $CI_PIPELINE_SOURCE == "push"   # Also run on normal branch pushes
  variables:
    GIT_SUBMODULE_STRATEGY: recursive  # Ensure submodules are updated
  script:
    # Set up Qt6 MSVC22 environment - on the build machine there should be a script to do this
    - '& "C:\bat\qt6_msvc22_env.ps1"'
    
    # Configure CMake build - cmake should be in the PATH of the build machine
    - cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
    
    # Build the project
    - cmake --build build

    # Deploy Qt runtime dependencies for cangaroo.exe
    # to have a runnable test application in Runtime folder
    - windeployqt build\bin\cangaroo.exe

    # Zip the Runtime folder
    - powershell -Command "Compress-Archive -Path 'build\bin\*' -DestinationPath 'cangaroo_alt.zip' -Force"

  artifacts:
      name: "cangaroo_${CI_COMMIT_TAG:-$CI_COMMIT_SHA}"
      expire_in: 7 days
      paths:
        - cangaroo_alt.zip
      when: always

# --------------------------------------------------------
# Release Job
# --------------------------------------------------------
release_job:
  stage: deploy
  image: curlimages/curl:latest
  rules:
    - if: $CI_COMMIT_TAG
  needs:
    - job: build
      artifacts: true
  script:
    - echo "Creating release for: $CI_COMMIT_TAG"

    # Try to create release (ignore if exists)
    - |
      curl --silent --show-error --fail \
        --request POST \
        --header "JOB-TOKEN: $CI_JOB_TOKEN" \
        --data "name=$CI_COMMIT_TAG" \
        --data "tag_name=$CI_COMMIT_TAG" \
        --data-urlencode "description=Automated release" \
        "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/releases" \
        || echo "Release already exists, continue..."

    # Upload artifact
    - |
      curl --silent --show-error --fail \
        --request POST \
        --header "JOB-TOKEN: $CI_JOB_TOKEN" \
        --form "file=@cangaroo_alt.zip" \
        "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/uploads" \
        > upload.json

    - UPLOAD_URL=$(cat upload.json | sed -n 's/.*"url":"\([^"]*\)".*/\1/p')
    - echo "Uploaded file URL: $UPLOAD_URL"

    # Add asset to release
    - |
      curl --silent --show-error --fail \
        --request POST \
        --header "JOB-TOKEN: $CI_JOB_TOKEN" \
        --data "name=cangaroo_alt.zip" \
        --data "url=${CI_PROJECT_URL}${UPLOAD_URL}" \
        "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/releases/$CI_COMMIT_TAG/assets/links"
    